<html>

<head>
	<title>P1</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
	<script>
		monthlyData = {}
		monthlyAverages = {}

		d3.csv("ks-projects-201801.csv", function (data) {

			data.forEach(function (project) {
				// Convert String values to numbers
				project["ID"] = +project["ID"];
				project.goal = +project.goal;
				project.pledged = +project.pledged;
				project.backers = +project.backers;
				project["usd pledged"] = +project["usd pledged"];
				project.backers = +project.backers;
				project.usd_pledged_real = +project.usd_pledged_real;
				project.usd_goal_real = +project.usd_goal_real;

				// Convert String values to dates
				project.deadline = new Date(project.deadline);
				project.launched = new Date(project.launched);

				// Bin by year and month
				year = project.deadline.getFullYear()
				month = project.deadline.getMonth()

				if (!(year in monthlyData)) {
					monthlyData[year] = {}
				}
				if (!(month in monthlyData[year])) {
					monthlyData[year][month] = []
				}
				monthlyData[year][month].push(project)
			});

			// Generate average data per month
			Object.keys(monthlyData).forEach(function (year) {

				monthlyAverages[year] = {}
				usd_goal_real = 0
				usd_pledged_real = 0
				backers = 0
				funded = 0

				Object.keys(monthlyData[year]).forEach(function (month) {
					monthlyAverages[year][month] = {}

					monthlyData[year][month].forEach(function (project) {
						usd_goal_real += project.usd_goal_real
						usd_pledged_real += project.usd_pledged_real
						backers += project.backers
						if (project.pledged > project.goal) {
							funded += 1;
						}
					})

					num = monthlyData[year][month].length

					monthlyAverages[year][month].usd_goal_real = usd_goal_real
					monthlyAverages[year][month].averageUsd_goal_real = usd_goal_real / num
					monthlyAverages[year][month].usd_pledged_real = usd_pledged_real
					monthlyAverages[year][month].averageUsd_pledged_real = usd_pledged_real / num
					monthlyAverages[year][month].backers = backers
					monthlyAverages[year][month].averageBackers = backers / num
					monthlyAverages[year][month].funded = funded
					monthlyAverages[year][month].percentFunded = funded / num
				});
			});


			// Data row type
			// "ID": number
			// "name": string
			// "category": string
			// "main_category": string
			// "currency": string
			// "deadline": date
			// "goal": number
			// "launched": date 
			// "pledged": number
			// "state": string
			// "backers": number
			// "country": string
			// "usd pledged": number
			// "usd_pledged_real": number
			// "usd_goal_real": number

			console.log(data[5]);
		});
	</script>
</body>

</html>